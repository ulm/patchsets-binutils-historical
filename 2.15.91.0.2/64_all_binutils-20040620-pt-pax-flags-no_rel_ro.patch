diff -ru binutils-2.15.91.0.1/bfd/elf-bfd.h binutils-2.15.91.0.1-pax/bfd/elf-bfd.h
--- binutils-2.15.91.0.1/bfd/elf-bfd.h	2004-06-20 20:48:48.577718624 +0930
+++ binutils-2.15.91.0.1-pax/bfd/elf-bfd.h	2004-06-20 20:20:20.000000000 +0930
@@ -1209,7 +1209,10 @@
   unsigned int cverrefs;
 
   /* Segment flags for the PT_GNU_STACK segment.  */
-  unsigned int stack_flags;  
+  unsigned int stack_flags;
+
+  /* Segment flags for the PT_PAX_FLAGS segment.  */
+  unsigned int pax_flags;
 
   /* Symbol version definitions in external objects.  */
   Elf_Internal_Verdef *verdef;
diff -ru binutils-2.15.91.0.1/bfd/elf.c binutils-2.15.91.0.1-pax/bfd/elf.c
--- binutils-2.15.91.0.1/bfd/elf.c	2004-06-20 20:48:48.561721056 +0930
+++ binutils-2.15.91.0.1-pax/bfd/elf.c	2004-06-20 20:26:12.000000000 +0930
@@ -995,6 +995,7 @@
 	    case PT_TLS: pt = "TLS"; break;
 	    case PT_GNU_EH_FRAME: pt = "EH_FRAME"; break;
 	    case PT_GNU_STACK: pt = "STACK"; break;
+            case PT_PAX_FLAGS: pt = "PAX_FLAGS"; break;
 	    default: sprintf (buf, "0x%lx", p->p_type); pt = buf; break;
 	    }
 	  fprintf (f, "%8s off    0x", pt);
@@ -2321,6 +2322,10 @@
     case PT_GNU_STACK:
       return _bfd_elf_make_section_from_phdr (abfd, hdr, index, "stack");
 
+    case PT_PAX_FLAGS:
+      return _bfd_elf_make_section_from_phdr (abfd, hdr, index, "pax_flags");
+
+
     default:
       /* Check for any processor-specific program segment types.
          If no handler for them, default to making "segment" sections.  */
@@ -3568,6 +3573,19 @@
       pm = &m->next;
     }
 
+    {
+      amt = sizeof (struct elf_segment_map);
+      m = bfd_zalloc (abfd, amt);
+      if (m == NULL)
+        goto error_return;
+      m->next = NULL;
+      m->p_type = PT_PAX_FLAGS;
+      m->p_flags = elf_tdata (abfd)->pax_flags;
+      m->p_flags_valid = 1;
+      *pm = m;
+      pm = &m->next;
+  }
+
   free (sections);
   sections = NULL;
 
@@ -4189,6 +4207,11 @@
       ++segs;
     }
 
+  {
+      /* We need a PT_PAX_FLAGS segment.  */
+       ++segs;
+  }
+
   for (s = abfd->sections; s != NULL; s = s->next)
     {
       if ((s->flags & SEC_LOAD) != 0
@@ -4738,6 +4761,7 @@
     || IS_COREFILE_NOTE (segment, section))				\
    && section->output_section != NULL					\
    && segment->p_type != PT_GNU_STACK					\
+   && segment->p_type != PT_PAX_FLAGS					\
    && (segment->p_type != PT_TLS					\
        || (section->flags & SEC_THREAD_LOCAL))				\
    && (segment->p_type == PT_LOAD					\
diff -ru binutils-2.15.91.0.1/bfd/elflink.c binutils-2.15.91.0.1-pax/bfd/elflink.c
--- binutils-2.15.91.0.1/bfd/elflink.c	2004-06-20 20:48:48.593716192 +0930
+++ binutils-2.15.91.0.1-pax/bfd/elflink.c	2004-06-20 20:35:55.000000000 +0930
@@ -4599,16 +4599,33 @@
   if (!is_elf_hash_table (info->hash))
     return TRUE;
 
+  elf_tdata (output_bfd)->pax_flags = PF_NORANDEXEC;
+
+  if (info->execheap)
+    elf_tdata (output_bfd)->pax_flags |= PF_NOMPROTECT;
+  else if (info->noexecheap)
+    elf_tdata (output_bfd)->pax_flags |= PF_MPROTECT;
+
+ /* elf_tdata (output_bfd)->relro = info->relro;
+ */
+
   if (info->execstack)
-    elf_tdata (output_bfd)->stack_flags = PF_R | PF_W | PF_X;
+    {
+      elf_tdata (output_bfd)->stack_flags = PF_R | PF_W | PF_X;
+      elf_tdata (output_bfd)->pax_flags |= PF_EMUTRAMP;
+    }
   else if (info->noexecstack)
-    elf_tdata (output_bfd)->stack_flags = PF_R | PF_W;
+    {
+      elf_tdata (output_bfd)->stack_flags = PF_R | PF_W;
+      elf_tdata (output_bfd)->pax_flags |= PF_NOEMUTRAMP;
+    }    
   else
     {
       bfd *inputobj;
       asection *notesec = NULL;
       int exec = 0;
 
+      elf_tdata (output_bfd)->pax_flags |= PF_NOEMUTRAMP;
       for (inputobj = info->input_bfds;
 	   inputobj;
 	   inputobj = inputobj->link_next)
@@ -4621,7 +4638,11 @@
 	  if (s)
 	    {
 	      if (s->flags & SEC_CODE)
-		exec = PF_X;
+               {
+                 elf_tdata (output_bfd)->pax_flags &= ~PF_NOEMUTRAMP;
+                 elf_tdata (output_bfd)->pax_flags |= PF_EMUTRAMP;
+                 exec = PF_X;
+               }
 	      notesec = s;
 	    }
 	  else
diff -ru binutils-2.15.91.0.1/binutils/readelf.c binutils-2.15.91.0.1-pax/binutils/readelf.c
--- binutils-2.15.91.0.1/binutils/readelf.c	2004-06-20 20:48:48.613713152 +0930
+++ binutils-2.15.91.0.1-pax/binutils/readelf.c	2004-06-20 20:36:54.000000000 +0930
@@ -2189,6 +2189,7 @@
     case PT_GNU_EH_FRAME:
 			return "GNU_EH_FRAME";
     case PT_GNU_STACK:	return "STACK";
+    case PT_PAX_FLAGS: return "PAX_FLAGS";
 
     default:
       if ((p_type >= PT_LOPROC) && (p_type <= PT_HIPROC))
diff -ru binutils-2.15.91.0.1/include/bfdlink.h binutils-2.15.91.0.1-pax/include/bfdlink.h
--- binutils-2.15.91.0.1/include/bfdlink.h	2004-06-20 20:48:48.624711480 +0930
+++ binutils-2.15.91.0.1-pax/include/bfdlink.h	2004-06-20 20:38:26.000000000 +0930
@@ -302,6 +302,15 @@
      flags.  */
   unsigned int noexecstack: 1;
 
+  /* TRUE if PT_PAX_FLAGS segment should be created with PF_NOMPROTECT
+     flags.  */
+  unsigned int execheap: 1;
+
+  /* TRUE if PT_PAX_FLAGS segment should be created with PF_MPROTECT
+     flags.  */
+  unsigned int noexecheap: 1;
+
+
   /* What to do with unresolved symbols in an object file.
      When producing executables the default is GENERATE_ERROR.
      When producing shared libraries the default is IGNORE.  The
diff -ru binutils-2.15.91.0.1/include/elf/common.h binutils-2.15.91.0.1-pax/include/elf/common.h
--- binutils-2.15.91.0.1/include/elf/common.h	2004-06-20 20:48:48.619712240 +0930
+++ binutils-2.15.91.0.1-pax/include/elf/common.h	2004-06-20 20:39:55.000000000 +0930
@@ -290,12 +290,27 @@
 
 #define PT_GNU_EH_FRAME	(PT_LOOS + 0x474e550)
 #define PT_GNU_STACK	(PT_LOOS + 0x474e551)
+#define PT_PAX_FLAGS   (PT_LOOS + 0x5041580)
 
 /* Program segment permissions, in program header p_flags field.  */
 
 #define PF_X		(1 << 0)	/* Segment is executable */
 #define PF_W		(1 << 1)	/* Segment is writable */
 #define PF_R		(1 << 2)	/* Segment is readable */
+
+#define PF_PAGEEXEC    (1 << 4)        /* Enable  PAGEEXEC */
+#define PF_NOPAGEEXEC  (1 << 5)        /* Disable PAGEEXEC */
+#define PF_SEGMEXEC    (1 << 6)        /* Enable  SEGMEXEC */
+#define PF_NOSEGMEXEC  (1 << 7)        /* Disable SEGMEXEC */
+#define PF_MPROTECT    (1 << 8)        /* Enable  MPROTECT */
+#define PF_NOMPROTECT  (1 << 9)        /* Disable MPROTECT */
+#define PF_RANDEXEC    (1 << 10)       /* Enable  RANDEXEC */
+#define PF_NORANDEXEC  (1 << 11)       /* Disable RANDEXEC */
+#define PF_EMUTRAMP    (1 << 12)       /* Enable  EMUTRAMP */
+#define PF_NOEMUTRAMP  (1 << 13)       /* Disable EMUTRAMP */
+#define PF_RANDMMAP    (1 << 14)       /* Enable  RANDMMAP */
+#define PF_NORANDMMAP  (1 << 15)       /* Disable RANDMMAP */
+
 /* #define PF_MASKOS	0x0F000000    *//* OS-specific reserved bits */
 #define PF_MASKOS	0x0FF00000	/* New value, Oct 4, 1999 Draft */
 #define PF_MASKPROC	0xF0000000	/* Processor-specific reserved bits */
diff -ru binutils-2.15.91.0.1/ld/emultempl/elf32.em binutils-2.15.91.0.1-pax/ld/emultempl/elf32.em
--- binutils-2.15.91.0.1/ld/emultempl/elf32.em	2004-06-20 20:48:51.377293024 +0930
+++ binutils-2.15.91.0.1-pax/ld/emultempl/elf32.em	2004-06-20 20:42:03.000000000 +0930
@@ -1694,6 +1694,16 @@
 	  link_info.noexecstack = TRUE;
 	  link_info.execstack = FALSE;
 	}
+      else if (strcmp (optarg, "execheap") == 0)
+       {
+         link_info.execheap = TRUE;
+         link_info.noexecheap = FALSE;
+       }
+      else if (strcmp (optarg, "noexecheap") == 0)
+       {
+         link_info.noexecheap = TRUE;
+         link_info.execheap = FALSE;
+       }
       /* What about the other Solaris -z options? FIXME.  */
       break;
 EOF
@@ -1730,6 +1740,7 @@
   fprintf (file, _("  -z combreloc\t\tMerge dynamic relocs into one section and sort\n"));
   fprintf (file, _("  -z defs\t\tReport unresolved symbols in object files.\n"));
   fprintf (file, _("  -z execstack\t\tMark executable as requiring executable stack\n"));
+  fprintf (file, _("  -z execheap\t\tMark executable as requiring executable heap\n"));
   fprintf (file, _("  -z initfirst\t\tMark DSO to be initialized first at runtime\n"));
   fprintf (file, _("  -z interpose\t\tMark object to interpose all DSOs but executable\n"));
   fprintf (file, _("  -z loadfltr\t\tMark object requiring immediate process\n"));
@@ -1741,6 +1752,7 @@
   fprintf (file, _("  -z nodlopen\t\tMark DSO not available to dlopen\n"));
   fprintf (file, _("  -z nodump\t\tMark DSO not available to dldump\n"));
   fprintf (file, _("  -z noexecstack\tMark executable as not requiring executable stack\n"));
+  fprintf (file, _("  -z noexecheap\t\tMark executable as not requiring executable heap\n"));
   fprintf (file, _("  -z now\t\tMark object non-lazy runtime binding\n"));
   fprintf (file, _("  -z origin\t\tMark object requiring immediate \$ORIGIN processing\n\t\t\t  at runtime\n"));
   fprintf (file, _("  -z KEYWORD\t\tIgnored for Solaris compatibility\n"));
diff -ru binutils-2.15.91.0.1/ld/ldgram.y binutils-2.15.91.0.1-pax/ld/ldgram.y
--- binutils-2.15.91.0.1/ld/ldgram.y	2004-06-20 20:48:48.998654632 +0930
+++ binutils-2.15.91.0.1-pax/ld/ldgram.y	2004-06-20 20:43:24.000000000 +0930
@@ -1026,6 +1026,8 @@
 			    $$ = exp_intop (0x6474e550);
 			  else if (strcmp (s, "PT_GNU_STACK") == 0)
 			    $$ = exp_intop (0x6474e551);
+			  else if (strcmp (s, "PT_PAX_FLAGS") == 0)
+                           $$ = exp_intop (0x65041580);
 			  else
 			    {
 			      einfo (_("\

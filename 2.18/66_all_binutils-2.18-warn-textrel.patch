textrels are bad for forcing copy-on-write (this affects everyone),
and for security/runtime code generation, this affects security ppl.
But in either case, it doesn't matter who needs textrels, it's
the very fact that they're needed at all.

2006-06-10  Ned Ludd  <solar@gentoo.org>, Mike Frysinger <vapier@gentoo.org>

	* bfd/elflink.c (bfd_elf_final_link): Check all objects for TEXTRELs.
	* ld/ldmain.c (main): Change textrel warning default to true.
	* ld/testsuite/lib/ld-lib.exp (default_ld_simple_link): Scrub TEXTREL
	warnings from ld output.

diff -Naurp binutils-2.18-orig/bfd/elflink.c binutils-2.18/bfd/elflink.c
--- binutils-2.18-orig/bfd/elflink.c	2008-07-19 23:40:31.000000000 -0600
+++ binutils-2.18/bfd/elflink.c	2008-07-19 23:44:59.000000000 -0600
@@ -10932,14 +10932,12 @@ bfd_elf_final_link (bfd *abfd, struct bf
 	goto error_return;
 
       /* Check for DT_TEXTREL (late, in case the backend removes it).  */
-      if (info->warn_shared_textrel && info->shared)
+      o = bfd_get_section_by_name (dynobj, ".dynamic");
+      if (info->warn_shared_textrel && o != NULL)
 	{
 	  bfd_byte *dyncon, *dynconend;
 
 	  /* Fix up .dynamic entries.  */
-	  o = bfd_get_section_by_name (dynobj, ".dynamic");
-	  BFD_ASSERT (o != NULL);
-
 	  dyncon = o->contents;
 	  dynconend = o->contents + o->size;
 	  for (; dyncon < dynconend; dyncon += bed->s->sizeof_dyn)
@@ -10951,7 +10949,7 @@ bfd_elf_final_link (bfd *abfd, struct bf
 	      if (dyn.d_tag == DT_TEXTREL)
 		{
 		 info->callbacks->einfo 
-		    (_("%P: warning: creating a DT_TEXTREL in a shared object.\n"));
+		    (_("%P: warning: creating a DT_TEXTREL in object.\n"));
 		  break;
 		}
 	    }
diff -Naurp binutils-2.18-orig/ld/ldmain.c binutils-2.18/ld/ldmain.c
--- binutils-2.18-orig/ld/ldmain.c	2007-08-06 14:00:21.000000000 -0600
+++ binutils-2.18/ld/ldmain.c	2008-07-19 23:46:19.000000000 -0600
@@ -280,6 +280,7 @@ main (int argc, char **argv)
   emulation = get_emulation (argc, argv);
   ldemul_choose_mode (emulation);
   default_target = ldemul_choose_target (argc, argv);
+  link_info.warn_shared_textrel = TRUE;
   lang_init ();
   ldemul_before_parse ();
   lang_has_input_file = FALSE;
diff -Naurp binutils-2.18-orig/ld/testsuite/ld-i386/warn1.d binutils-2.18/ld/testsuite/ld-i386/warn1.d
--- binutils-2.18-orig/ld/testsuite/ld-i386/warn1.d	2007-04-05 10:16:28.000000000 -0600
+++ binutils-2.18/ld/testsuite/ld-i386/warn1.d	2008-07-19 23:46:19.000000000 -0600
@@ -1,4 +1,4 @@
 #name: --warn-shared-textrel --fatal-warnings
 #as: --32
 #ld: -shared -melf_i386 --warn-shared-textrel --fatal-warnings
-#error: .*warning: creating a DT_TEXTREL in a shared object.
+#error: .*warning: creating a DT_TEXTREL in object.
diff -Naurp binutils-2.18-orig/ld/testsuite/lib/ld-lib.exp binutils-2.18/ld/testsuite/lib/ld-lib.exp
--- binutils-2.18-orig/ld/testsuite/lib/ld-lib.exp	2008-07-19 23:38:42.000000000 -0600
+++ binutils-2.18/ld/testsuite/lib/ld-lib.exp	2008-07-19 23:46:19.000000000 -0600
@@ -194,6 +194,10 @@ proc default_ld_simple_link { ld target 
     # symbol, since the default linker script might use ENTRY.
     regsub -all "(^|\n)(\[^\n\]*: warning: cannot find entry symbol\[^\n\]*\n?)" $exec_output "\\1" exec_output
 
+    # Gentoo tweak:
+    # We want to ignore TEXTREL warnings since we force enable them by default
+    regsub -all "^.*ld-new: warning: creating a DT_TEXTREL in object\." $exec_output "\\1" exec_output
+
     if [string match "" $exec_output] then {
 	return 1
     } else {

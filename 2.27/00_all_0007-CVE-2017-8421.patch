From 066b5b9598ffcf4d8e99034fa370e1ba8393341c Mon Sep 17 00:00:00 2001
From: Matthias Maier <tamiko@43-1.org>
Date: Tue, 6 Jun 2017 13:04:17 -0500
Subject: [PATCH 1/5] CVE-2017-8421

[PATCH] Prevent memory exhaustion from a corrupt PE binary with an overlarge number of relocs.

Patch taken from [1]. Gentoo bug [2]

[1] https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;a=patch;h=39ff1b79f687b65f4144ddb379f22587003443fb
[2] https://bugs.gentoo.org/show_bug.cgi?id=618520
---
 binutils/objdump.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/binutils/objdump.c b/binutils/objdump.c
index bf9c592..cbe2e0a 100644
--- a/binutils/objdump.c
+++ b/binutils/objdump.c
@@ -3238,6 +3238,14 @@ dump_relocs_in_section (bfd *abfd,
       return;
     }
 
+  if ((bfd_get_file_flags (abfd) & (BFD_IN_MEMORY | BFD_LINKER_CREATED)) == 0
+      && relsize > get_file_size (bfd_get_filename (abfd)))
+    {
+      printf (" (too many: 0x%x)\n", section->reloc_count);
+      bfd_set_error (bfd_error_file_truncated);
+      bfd_fatal (bfd_get_filename (abfd));
+    }
+
   relpp = (arelent **) xmalloc (relsize);
   relcount = bfd_canonicalize_reloc (abfd, section, relpp, syms);
 
-- 
2.13.0

